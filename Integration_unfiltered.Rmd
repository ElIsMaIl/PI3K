---
title: "Integration unfiltered seurat"
description: |
  Overview of data analysis.
author:
  - name: Manuela Benary / Mohammad El-Ismail
    affiliation: CUBI / CCCC
    affiliation_url: 
date: "`r Sys.Date()`"
bibliography: literature.bib
output: 
  distill::distill_article:
    toc: true
    toc_depth: 2
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r load-libraries}
library(Seurat)
library(tidyverse)
library(RCurl)
library(cowplot)
```

```{r}
options(future.globals.maxSize = 3 * 1024^3)
```

## Performing integration on datasets normalized with SCTransform
# unfiltered_sct_mt_seurat

```{r}
#split_unfiltered_sct_mt_seurat <- readRDS("data/split_unfiltered_sct_mt_seurat.rds")
```

```{r}
#integ_features <- SelectIntegrationFeatures(object.list = split_unfiltered_sct_mt_seurat, 
#                                            nfeatures = 3000) 
```

```{r select features and run PCA}
#split_unfiltered_sct_mt_seurat <- PrepSCTIntegration(object.list = split_unfiltered_sct_mt_seurat, 
#                                   anchor.features = integ_features)
```

```{r}
# integ_anchors <- FindIntegrationAnchors(object.list = split_unfiltered_sct_mt_seurat, 
#                                         normalization.method = "SCT", 
#                                         anchor.features = integ_features)
```

```{r Integrate across conditions}
# integrated_unfiltered_sct_mt_seurat <- IntegrateData(anchorset = integ_anchors, 
#                                           normalization.method = "SCT")
```

```{r downstream analysis on the corrected data}
#DefaultAssay(integrated_unfiltered_sct_mt_seurat) <- "integrated"
```

```{r}
integrated_unfiltered_sct_mt_seurat <- readRDS("data/integrated_unfiltered_sct_mt_seurat.rds")
```

```{r workflow for visualization and clustering}
# integrated_unfiltered_sct_mt_seurat <- ScaleData(integrated_unfiltered_sct_mt_seurat, verbose = FALSE)
# integrated_unfiltered_sct_mt_seurat <- RunPCA(integrated_unfiltered_sct_mt_seurat, npcs = 30, verbose = FALSE)
# integrated_unfiltered_sct_mt_seurat <- RunUMAP(integrated_unfiltered_sct_mt_seurat, reduction = "pca", dims = 1:30)
# integrated_unfiltered_sct_mt_seurat <- FindNeighbors(integrated_unfiltered_sct_mt_seurat, reduction = "pca", dims = 1:30)
# integrated_unfiltered_sct_mt_seurat <- FindClusters(integrated_unfiltered_sct_mt_seurat, resolution = 0.5)
```

```{r Visualization}
p1 <- DimPlot(integrated_unfiltered_sct_mt_seurat, reduction = "umap", group.by = "Sample_Tag")
p2 <- DimPlot(integrated_unfiltered_sct_mt_seurat, reduction = "umap", label = TRUE, repel = TRUE)
p3 <- DimPlot(integrated_unfiltered_sct_mt_seurat, reduction = "umap", split.by = "Sample_Tag")
p1
p2
p3
```

```{r}
#PCAPlot(integrated_seurat, split.by = "seq_folder")
```

```{r}
#saveRDS(integrated_unfiltered_sct_mt_seurat, "data/integrated_unfiltered_sct_mt_seurat.rds")
```

## Fast Integration using RPCA
#split_unfiltered_seurat with mt regression

```{r}
#split_unfiltered_seurat <- readRDS("data/split_unfiltered_seurat.rds")
```

```{r}
# split_unfiltered_seurat <- lapply(X = split_unfiltered_seurat, FUN = function(x) {
#     x <- NormalizeData(x)
#     x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000)
# })
```

```{r}
# features <- SelectIntegrationFeatures(object.list = split_unfiltered_seurat)
# split_unfiltered_seurat <- lapply(X = split_unfiltered_seurat, FUN = function(x) {
#     x <- ScaleData(x, vars.to.regress = c("percent.mt"), features = features, verbose = FALSE)
#     x <- RunPCA(x, features = features, verbose = FALSE)
# })
```

```{r}
# integrated_unfiltered_rpca_mt_seurat <- FindIntegrationAnchors(object.list = split_unfiltered_seurat, anchor.features = features, reduction = "rpca")
```

```{r}
#integrated_unfiltered_rpca_mt_seurat <- IntegrateData(anchorset = integrated_unfiltered_rpca_mt_seurat)
```

```{r}
integrated_unfiltered_rpca_mt_seurat <- readRDS("data/integrated_unfiltered_rpca_mt_seurat.rds")
```

```{r}
# # Run the standard workflow for visualization and clustering
# integrated_unfiltered_rpca_mt_seurat <- ScaleData(integrated_unfiltered_rpca_mt_seurat, verbose = FALSE)
# integrated_unfiltered_rpca_mt_seurat <- RunPCA(integrated_unfiltered_rpca_mt_seurat, npcs = 30, verbose = FALSE)
# integrated_unfiltered_rpca_mt_seurat <- RunUMAP(integrated_unfiltered_rpca_mt_seurat, reduction = "pca", dims = 1:30)
# integrated_unfiltered_rpca_mt_seurat <- FindNeighbors(integrated_unfiltered_rpca_mt_seurat, reduction = "pca", dims = 1:30)
# integrated_unfiltered_rpca_mt_seurat <- FindClusters(integrated_unfiltered_rpca_mt_seurat, resolution = 0.5)
```   

```{r}
p1_rpca <- DimPlot(integrated_unfiltered_rpca_mt_seurat, reduction = "umap", group.by = "Sample_Tag")
p2_rpca <- DimPlot(integrated_unfiltered_rpca_mt_seurat, reduction = "umap", label = TRUE, repel = TRUE)
p3_rpca <- DimPlot(integrated_unfiltered_rpca_mt_seurat, reduction = "umap", split.by = "Sample_Tag")
p1_rpca
p2_rpca
p3_rpca
```

```{r}
#saveRDS(integrated_unfiltered_rpca_mt_seurat, "data/integrated_unfiltered_rpca_mt_seurat.rds")
```


## Performing integration on datasets normalized with SCTransform
# unfiltered_sct_phase_seurat

```{r}
#split_unfiltered_sct_phase_seurat <- readRDS("data/split_unfiltered_sct_phase_seurat.rds")
```

```{r }
# integ_features <- SelectIntegrationFeatures(object.list = split_unfiltered_sct_phase_seurat, 
#                                             nfeatures = 3000) 
```

```{r}
# split_unfiltered_sct_phase_seurat <- PrepSCTIntegration(object.list = split_unfiltered_sct_phase_seurat,
#                                                         anchor.features = integ_features)
```

```{r}
# integ_anchors <- FindIntegrationAnchors(object.list = split_unfiltered_sct_phase_seurat, 
#                                         normalization.method = "SCT", 
#                                         anchor.features = integ_features)
```

```{r}
# integrated_unfiltered_sct_phase_seurat <- IntegrateData(anchorset = integ_anchors, 
#                                           normalization.method = "SCT")
```

```{r}
#DefaultAssay(integrated_unfiltered_sct_phase_seurat) <- "integrated"
```

```{r}
integrated_unfiltered_sct_phase_seurat <- readRDS("data/integrated_unfiltered_sct_phase_seurat.rds")
```

```{r}
# integrated_unfiltered_sct_phase_seurat <- ScaleData(integrated_unfiltered_sct_phase_seurat, verbose = FALSE)
# integrated_unfiltered_sct_phase_seurat <- RunPCA(integrated_unfiltered_sct_phase_seurat, npcs = 30, verbose = FALSE)
# integrated_unfiltered_sct_phase_seurat <- RunUMAP(integrated_unfiltered_sct_phase_seurat, reduction = "pca", dims = 1:30)
# integrated_unfiltered_sct_phase_seurat <- FindNeighbors(integrated_unfiltered_sct_phase_seurat, reduction = "pca", dims = 1:30)
# integrated_unfiltered_sct_phase_seurat <- FindClusters(integrated_unfiltered_sct_phase_seurat, resolution = 0.5)
```

```{r}
p4 <- DimPlot(integrated_unfiltered_sct_phase_seurat, reduction = "umap", group.by = "Sample_Tag")
p5 <- DimPlot(integrated_unfiltered_sct_phase_seurat, reduction = "umap", label = TRUE, repel = TRUE)
p6 <- DimPlot(integrated_unfiltered_sct_phase_seurat, reduction = "umap", split.by = "Sample_Tag")
p4
p5
p6
```

```{r}
#PCAPlot(integrated_seurat, split.by = "seq_folder")
```

```{r}
#saveRDS(integrated_unfiltered_sct_phase_seurat, "data/integrated_unfiltered_sct_phase_seurat.rds")
```

## Fast Integration using RPCA
#split_unfiltered_seurat with phase regression

```{r}
#split_unfiltered_seurat <- readRDS("data/split_unfiltered_seurat.rds")
```

```{r}
# split_unfiltered_seurat <- lapply(X = split_unfiltered_seurat, FUN = function(x) {
#     x <- NormalizeData(x)
#     x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000)
# })
```

```{r}
# features <- SelectIntegrationFeatures(object.list = split_unfiltered_seurat)
# split_unfiltered_seurat <- lapply(X = split_unfiltered_seurat, FUN = function(x) {
#     x <- ScaleData(x, vars.to.regress = c("S.Score", "G2M.Score"), features = features, verbose = FALSE)
#     x <- RunPCA(x, features = features, verbose = FALSE)
# })
```

```{r}
#integrated_unfiltered_rpca_phase_seurat <- FindIntegrationAnchors(object.list = split_unfiltered_seurat, anchor.features = features, reduction = "rpca")
```

```{r}
#integrated_unfiltered_rpca_phase_seurat <- IntegrateData(anchorset = integrated_unfiltered_rpca_phase_seurat)
```

```{r}
integrated_unfiltered_rpca_phase_seurat <- readRDS("data/integrated_unfiltered_rpca_phase_seurat")
```

```{r}
# Run the standard workflow for visualization and clustering
# integrated_unfiltered_rpca_phase_seurat <- ScaleData(integrated_unfiltered_rpca_phase_seurat, verbose = FALSE)
# integrated_unfiltered_rpca_phase_seurat <- RunPCA(integrated_unfiltered_rpca_phase_seurat, npcs = 30, verbose = FALSE)
# integrated_unfiltered_rpca_phase_seurat <- RunUMAP(integrated_unfiltered_rpca_phase_seurat, reduction = "pca", dims = 1:30)
# integrated_unfiltered_rpca_phase_seurat <- FindNeighbors(integrated_unfiltered_rpca_phase_seurat, reduction = "pca", dims = 1:30)
# integrated_unfiltered_rpca_phase_seurat <- FindClusters(integrated_unfiltered_rpca_phase_seurat, resolution = 0.5)
```   

```{r}
p4_rpca <- DimPlot(integrated_unfiltered_rpca_phase_seurat, reduction = "umap", group.by = "Sample_Tag")
p5_rpca <- DimPlot(integrated_unfiltered_rpca_phase_seurat, reduction = "umap", label = TRUE, repel = TRUE)
p6_rpca <- DimPlot(integrated_unfiltered_rpca_phase_seurat, reduction = "umap", split.by = "Sample_Tag")
p4_rpca
p5_rpca
p6_rpca
```

```{r}
#saveRDS(integrated_unfiltered_rpca_phase_seurat, "data/integrated_unfiltered_rpca_phase_seurat.rds")
```


## Performing integration on datasets normalized with SCTransform
# unfiltered_sct_mt_phase_seurat

```{r}
#split_unfiltered_sct_mt_phase_seurat <- readRDS("data/split_unfiltered_sct_mt_phase_seurat.rds")
```

```{r }
# integ_features <- SelectIntegrationFeatures(object.list = split_unfiltered_sct_mt_phase_seurat, 
#                                             nfeatures = 3000) 
```

```{r}
# split_unfiltered_sct_mt_phase_seurat <- PrepSCTIntegration(object.list = split_unfiltered_sct_mt_phase_seurat, 
#                                                            anchor.features = integ_features)
```

```{r}
# integ_anchors <- FindIntegrationAnchors(object.list = split_unfiltered_sct_mt_phase_seurat, 
#                                         normalization.method = "SCT", 
#                                         anchor.features = integ_features)
```

```{r}
# integrated_unfiltered_sct_mt_phase_seurat <- IntegrateData(anchorset = integ_anchors, 
#                                                            normalization.method = "SCT")
```

```{r}
#DefaultAssay(integrated_unfiltered_sct_mt_phase_seurat) <- "integrated"
```

```{r}
# integrated_unfiltered_sct_mt_phase_seurat <- ScaleData(integrated_unfiltered_sct_mt_phase_seurat, verbose = FALSE)
# integrated_unfiltered_sct_mt_phase_seurat <- RunPCA(integrated_unfiltered_sct_mt_phase_seurat, npcs = 30, verbose = FALSE)
# integrated_unfiltered_sct_mt_phase_seurat <- RunUMAP(integrated_unfiltered_sct_mt_phase_seurat, reduction = "pca", dims = 1:30)
# integrated_unfiltered_sct_mt_phase_seurat <- FindNeighbors(integrated_unfiltered_sct_mt_phase_seurat, reduction = "pca", dims = 1:30)
# integrated_unfiltered_sct_mt_phase_seurat <- FindClusters(integrated_unfiltered_sct_mt_phase_seurat, resolution = 0.5)
```

```{r}
# p7 <- DimPlot(integrated_unfiltered_sct_mt_phase_seurat, reduction = "umap", group.by = "Sample_Tag")
# p8 <- DimPlot(integrated_unfiltered_sct_mt_phase_seurat, reduction = "umap", label = TRUE, repel = TRUE)
# p9 <- DimPlot(integrated_unfiltered_sct_mt_phase_seurat, reduction = "umap", split.by = "Sample_Tag")
# p7
# p8
# p9
```

```{r}
#PCAPlot(integrated_seurat, split.by = "seq_folder")
```

```{r}
#saveRDS(integrated_unfiltered_sct_mt_phase_seurat, "data/integrated_unfiltered_sct_mt_phase_seurat.rds")
```

## Fast Integration using RPCA
#split_unfiltered_seurat with mt and phase regression

```{r}
#split_unfiltered_seurat <- readRDS("data/split_unfiltered_seurat.rds")
```

```{r}
# split_unfiltered_seurat <- lapply(X = split_unfiltered_seurat, FUN = function(x) {
#     x <- NormalizeData(x)
#     x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000)
# })
```

```{r}
# features <- SelectIntegrationFeatures(object.list = split_unfiltered_seurat)
# split_unfiltered_seurat <- lapply(X = split_unfiltered_seurat, FUN = function(x) {
#     x <- ScaleData(x, vars.to.regress = c("S.Score", "G2M.Score", "percent.mt"), features = features, verbose = FALSE)
#     x <- RunPCA(x, features = features, verbose = FALSE)
# })
```

```{r}
# integrated_unfiltered_rpca_mt_phase_seurat <- FindIntegrationAnchors(object.list = split_unfiltered_seurat, anchor.features = features, reduction = "rpca")
```

```{r}
#integrated_unfiltered_rpca_mt_phase_seurat <- IntegrateData(anchorset = integrated_unfiltered_rpca_mt_phase_seurat)
```

```{r}
# Run the standard workflow for visualization and clustering
# integrated_unfiltered_rpca_mt_phase_seurat <- ScaleData(integrated_unfiltered_rpca_mt_phase_seurat, verbose = FALSE)
# integrated_unfiltered_rpca_mt_phase_seurat <- RunPCA(integrated_unfiltered_rpca_mt_phase_seurat, npcs = 30, verbose = FALSE)
# integrated_unfiltered_rpca_mt_phase_seurat <- RunUMAP(integrated_unfiltered_rpca_mt_phase_seurat, reduction = "pca", dims = 1:30)
# integrated_unfiltered_rpca_mt_phase_seurat <- FindNeighbors(integrated_unfiltered_rpca_mt_phase_seurat, reduction = "pca", dims = 1:30)
# integrated_unfiltered_rpca_mt_phase_seurat <- FindClusters(integrated_unfiltered_rpca_mt_phase_seurat, resolution = 0.5)
```   

```{r}
# p7_rpca <- DimPlot(integrated_unfiltered_rpca_mt_phase_seurat, reduction = "umap", group.by = "Sample_Tag")
# p8_rpca <- DimPlot(integrated_unfiltered_rpca_mt_phase_seurat, reduction = "umap", label = TRUE, repel = TRUE)
# p9_rpca <- DimPlot(integrated_unfiltered_rpca_mt_phase_seurat, reduction = "umap", split.by = "Sample_Tag")
# p7_rpca
# p8_rpca
# p9_rpca
```

```{r}
#saveRDS(integrated_unfiltered_rpca_mt_phase_seurat, "data/integrated_unfiltered_rpca_mt_phase_seurat.rds")
```
